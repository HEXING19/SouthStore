import { headers } from 'next/headers';
import { verifyPayFastSignature } from './signature';

/**
 * PayFast valid IPs for ITN (Instant Transaction Notification)
 */
const PAYFAST_VALID_IPS = [
  '41.74.179.228',
  '41.74.179.229',
  '41.74.179.230',
  '41.74.179.231',
  '41.74.182.10',
  '41.74.182.12',
  '41.74.182.13',
  '41.74.182.14',
  '41.74.182.15',
  '41.74.182.16',
  '41.74.182.17',
  '41.74.182.18',
  '41.74.182.19',
  '41.74.182.20',
  '41.74.182.21',
  '41.74.182.22',
  '41.74.182.23',
  '41.74.182.24',
  '41.74.182.25',
  '41.74.182.26',
  '41.74.182.27',
  '41.74.182.28',
  '41.74.182.29',
  '41.74.182.30',
  '41.74.182.31',
  '41.74.182.32',
  '41.74.182.33',
  '41.74.182.34',
  '41.74.182.35',
  '41.74.182.36',
  '41.74.182.37',
  '41.74.182.38',
  '41.74.182.39',
  '41.74.182.40',
  '41.74.182.41',
  '41.74.182.42',
  '41.74.182.43',
  '41.74.182.44',
  '41.74.182.45',
  '41.74.182.46',
  '41.74.182.47',
  '41.74.182.48',
  '41.74.182.49',
  '41.74.182.50',
  '41.74.182.51',
  '41.74.182.52',
  '41.74.182.53',
  '41.74.182.54',
  '41.74.182.55',
  '41.74.182.56',
  '41.74.182.57',
  '41.74.182.58',
  '41.74.182.59',
  '41.74.182.60',
  '41.74.182.61',
  '41.74.182.62',
  '41.74.182.63',
  '41.74.182.64',
  '41.74.182.65',
  '41.74.182.66',
  '41.74.182.67',
  '41.74.182.68',
  '41.74.182.69',
  '41.74.182.70',
  '41.74.182.71',
  '41.74.182.72',
  '41.74.182.182',
  '41.74.179.100',
  '41.74.179.101',
  '41.74.179.102',
  '41.74.179.103',
  '41.74.179.104',
  '41.74.179.105',
  '41.74.179.106',
  '41.74.179.107',
  '41.74.179.108',
  '41.74.179.109',
  '41.74.179.110',
  '41.74.179.111',
  '41.74.179.112',
  '41.74.179.113',
  '41.74.179.114',
  '41.74.179.115',
  '41.74.179.116',
  '41.74.179.117',
  '41.74.179.118',
  '41.74.179.119',
  '41.74.179.120',
  '41.74.179.121',
  '41.74.179.122',
  '41.74.179.123',
  '41.74.179.124',
  '41.74.179.125',
  '41.74.179.126',
  '41.74.179.127',
  '41.74.179.128',
  '41.74.179.129',
  '41.74.179.130',
  '41.74.179.131',
  '41.74.179.132',
  '41.74.179.133',
  '41.74.179.134',
  '41.74.179.135',
  '41.74.179.136',
  '41.74.179.137',
  '41.74.179.138',
  '41.74.179.139',
  '41.74.179.140',
  '41.74.179.141',
  '41.74.179.142',
  '41.74.179.143',
  '41.74.179.144',
  '41.74.179.145',
  '41.74.179.146',
  '41.74.179.147',
  '41.74.179.148',
  '41.74.179.149',
  '41.74.179.150',
  '41.74.179.151',
  '41.74.179.152',
  '41.74.179.153',
  '41.74.179.154',
  '41.74.179.155',
  '41.74.179.156',
  '41.74.179.157',
  '41.74.179.158',
  '41.74.179.159',
  '41.74.179.160',
  '41.74.179.161',
  '41.74.179.162',
  '41.74.179.163',
  '41.74.179.164',
  '41.74.179.165',
  '41.74.179.166',
  '41.74.179.167',
  '41.74.179.168',
  '41.74.179.169',
  '41.74.179.170',
  '41.74.179.171',
  '41.74.179.172',
  '41.74.179.173',
  '41.74.179.174',
  '41.74.179.175',
  '41.74.179.176',
  '41.74.179.177',
  '41.74.179.178',
  '41.74.179.179',
  '41.74.179.180',
  '41.74.179.181',
  '41.74.179.182',
  '41.74.179.183',
  '41.74.179.184',
  '41.74.179.185',
  '41.74.179.186',
  '41.74.179.187',
  '41.74.179.188',
  '41.74.179.189',
  '41.74.179.190',
  '41.74.179.191',
  '41.74.179.192',
  '41.74.179.193',
  '41.74.179.194',
  '41.74.179.195',
  '41.74.179.196',
  '41.74.179.197',
  '41.74.179.198',
  '41.74.179.199',
  '41.74.179.200',
  '41.74.179.201',
  '41.74.179.202',
  '41.74.179.203',
  '41.74.179.204',
  '41.74.179.205',
  '41.74.179.206',
  '41.74.179.207',
  '41.74.179.208',
  '41.74.179.209',
  '41.74.179.210',
  '41.74.179.211',
  '41.74.179.212',
  '41.74.179.213',
  '41.74.179.214',
  '41.74.179.215',
  '41.74.179.216',
  '41.74.179.217',
  '41.74.179.218',
  '41.74.179.219',
  '41.74.179.220',
  '41.74.179.221',
  '41.74.179.222',
  '41.74.179.223',
  '41.74.179.224',
  '41.74.179.225',
  '41.74.179.226',
  '41.74.179.227',
  '41.74.179.228',
  '41.74.179.229',
  '41.74.179.230',
  '41.74.179.231',
];

/**
 * Verify PayFast ITN (Instant Transaction Notification)
 * @param data - ITN data received from PayFast
 * @param receivedSignature - Signature from PayFast
 * @param passphrase - PayFast passphrase
 * @returns true if ITN is valid
 */
export async function verifyPayFastITN(
  data: Record<string, string>,
  receivedSignature: string,
  passphrase: string
): Promise<{ valid: boolean; error?: string }> {
  // 1. Verify signature
  const isValidSignature = verifyPayFastSignature(data, receivedSignature, passphrase);
  if (!isValidSignature) {
    return { valid: false, error: 'Invalid signature' };
  }

  // 2. Verify payment status
  if (data.payment_status !== 'COMPLETE') {
    return { valid: false, error: `Payment status is ${data.payment_status}, expected COMPLETE` };
  }

  // 3. Verify source IP (optional but recommended)
  // Note: Skip IP verification in development mode
  if (process.env.NODE_ENV === 'production') {
    try {
      const headersList = await headers();
      const forwarded = headersList.get('x-forwarded-for');
      const xRealIp = headersList.get('x-real-ip');
      const ip = forwarded?.split(',')[0]?.trim() || xRealIp;

      if (!ip || !PAYFAST_VALID_IPS.includes(ip)) {
        return { valid: false, error: `Invalid source IP: ${ip}` };
      }
    } catch (error) {
      // If we can't verify IP, log but don't fail
      console.error('Failed to verify IP:', error);
    }
  }

  return { valid: true };
}
